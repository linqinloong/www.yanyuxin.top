# Base images 基础镜像
FROM python:3.10.11

# MAINTAINER 维护者信息
maintainer linqinloong

# 创建工作目录
RUN mkdir -p /data/www/

# 工作目录
WORKDIR /data/www/

# RUN 执行以下命令
RUN apt update
RUN apt upgrade -y
RUN apt install openssh-server -y
RUN pip install --upgrade pip
RUN pip install virtualenv
RUN virtualenv venv
# 进入虚拟环境
RUN . venv/bin/activate
RUN pip install flask
RUN pip install uwsgi
# PermitRootLogin改为yes
COPY sshd_config /etc/ssh/sshd_config

# 密码改为root，可以用运行容器时的-e参数代替直接RUN passwd root会报错
# RUN passwd root
#设置用于ssh连接的root密码
RUN echo 'root:yyx'|chpasswd
# 装完ssh后不会手动启动，因此start就行，因此换位容器启动时执行命令
# RUN service ssh restart
# start失败了，不知道为什么构建镜像时没说，但是容器构建好后service ssh status确实是failed的,因此再后面直接用CMD起服务了
# RUN service ssh start

 
# 暴露端口
EXPOSE 8000 22

# 拷贝文件至工作目录
COPY app.py /data/www/app.py
COPY start_command.sh /data/www/start_command.sh
         


# 容器启动时执行命令
# CMD ["service ssh start"]运行不起来，下面才可以
# -D参数表示以守护进程模式运行SSH服务，即在前台持续运行而不是在后台运行。
# CMD ["/usr/sbin/sshd", "-D"]
# 还是没启动
CMD ["./start_command.sh"]
